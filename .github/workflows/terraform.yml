name: Terraform Azure Infrastructure Deployment

on:
  workflow_dispatch:
  push:
    paths:
      - 'IaC/**'
      - '.github/workflows/**'

env:
  TF_WORKING_DIR: ./IaC

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      TERRAFORM_SP_OBJECT_ID: ${{ secrets.TERRAFORM_SP_OBJECT_ID }}
      SQL_ADMIN_LOGIN: ${{ secrets.SQL_ADMIN_LOGIN }}
      SQL_ADMIN_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
      MY_IP_ADDRESS: ${{ secrets.MY_IP_ADDRESS }}

    steps:
      # 1. Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # 3. Terraform fmt (format check)
      - name: Terraform Fmt
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform fmt -recursive

      # 4. Terraform Init
      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false -upgrade

      # 5. Terraform validate
      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      # 6. Terraform Plan
      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform plan \
              -var="sql_admin_login=${{ env.SQL_ADMIN_LOGIN }}" \
              -var="sql_admin_password=${{ env.SQL_ADMIN_PASSWORD }}" \
              -var="my_ip_address=${{ env.MY_IP_ADDRESS }}" \
              -var="terraform_sp_object_id=${{ env.TERRAFORM_SP_OBJECT_ID }}"

      # 7. Manual approval before Apply (GitHub environment approval)
      - name: Wait for approval
        uses: hmarr/auto-approve-action@v2

      # 8. Terraform Apply
      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -auto-approve \
              -var="sql_admin_login=${{ env.SQL_ADMIN_LOGIN }}" \
              -var="sql_admin_password=${{ env.SQL_ADMIN_PASSWORD }}" \
              -var="my_ip_address=${{ env.MY_IP_ADDRESS }}" \
              -var="terraform_sp_object_id=${{ env.TERRAFORM_SP_OBJECT_ID }}"
